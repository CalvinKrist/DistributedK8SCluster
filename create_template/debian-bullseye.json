{
    "variables": {
      "proxmox_host": null,
      "proxmox_node": null,
      "proxmox_api_user": null,
      "proxmox_api_password": null
    },
    "sensitive-variables": ["proxmox_api_password"],
    "builders": [
      {
        "type": "proxmox-iso",
        "proxmox_url": "https://{{ user `proxmox_host` }}/api2/json",
        "insecure_skip_tls_verify": true,
        "username": "{{ user `proxmox_api_user` }}",
        "password": "{{ user `proxmox_api_password` }}",
  
        "template_description": "Debian 11 cloud-init template. Built on {{ isotime \"2006-01-02T15:04:05Z\" }}",
        "node": "{{user `proxmox_node`}}",
        "network_adapters": [
          {
            "model": "virtio",
            "bridge": "vmbr0",
            "firewall": true
          }
        ],
        "disks": [
          {
            "type": "scsi",
            "disk_size": "20G",
            "storage_pool": "local-lvm",
            "storage_pool_type": "lvm",
            "format": "raw",
            "io_thread": true
          }
        ],
        "scsi_controller": "virtio-scsi-single",
  
        "iso_file": "local:iso/debian.iso",
        "http_directory": "./",
        "boot_wait": "10s",
        "boot_command": [
          "<esc><wait>auto url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg<enter>"
        ],
        "unmount_iso": true,
  
        "cloud_init": true,
        "cloud_init_storage_pool": "local-lvm",
  
        "vm_name": "{{ user `template_name` }}",
        "vm_id": "{{ user `vmid` }}",
        "memory": "2048",
        
        "sockets": "1",
        "cores": "2",
        "os": "l26",
  
        "ssh_timeout": "90m",
        "ssh_username": "root",
        "ssh_password": "packer"
      }
    ],
    "provisioners": [
      {
        "type": "file",
        "source": "cloud.cfg",
        "destination": "/etc/cloud/cloud.cfg"
      },
      {
        "type": "ansible",
        "playbook_file": "../playbooks/install-netmaker.yml",
        "extra_arguments": ["--extra-vars", "{'netmaker_token': '{{user `netmaker_token`}}'}"] 
      },
      {
        "type": "ansible",
        "playbook_file": "../playbooks/setup-k8s.yml",
        "extra_arguments": ["--extra-vars", "{'root_password': '{{user `root_password`}}', 'username': '{{user `username`}}', 'password': '{{user `password`}}'}"] 
      }
    ]
  }
